{% extends 'base.html' %} {% block content %}
<div class="">
  <div class="row justify-content-around mb-5">
    <div class="col-4">
      <h1
        class="heading-tab"
        style="background: {{context.colour}}; box-shadow: {{context.colour|adjust_colour(1.1)}} 0px 0px 5px 10px;"
      >
        {{ context.section }}
      </h1>
    </div>
    <div class="col-4">
      {% for badge in context.badges %} {% if badge.complete %}
      <svg height="50" width="50" xmlns="http://www.w3.org/2000/svg">
        <circle
          r="10"
          cx="20"
          cy="20"
          fill="{{context.colour|adjust_colour(0.3)}}"
        />
      </svg>
      {% else %}
      <svg height="50" width="50" xmlns="http://www.w3.org/2000/svg">
        <circle r="10" cx="20" cy="20" fill="{{context.colour}}" />
      </svg>
      {% endif %} {% endfor %}
    </div>
    <div
      class="col-1 section-percent"
      style="border: solid 5px {{context.colour}}"
    >
      {{context.percentage|percentage_format}}
    </div>
  </div>
  <div id="badge-table" class="table table-dark"></div>
</div>
{% endblock %} {% block scripts %}
<script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
<script>
    const tableDiv = document.getElementById("badge-table");

    const editableCellAttributes = (data, row, col) => {
      if (row) {
        return {contentEditable: 'true', 'data-element-id': row.cells[0].data};
      }
      else {
        return {};
      }
  };

    new gridjs.Grid({
      columns: [
        { id: 'icon', name: 'Icon', sort: false },
        { id: 'name', name: 'Name' },
        { id: 'progress', name: 'Progress' },
        { id: 'rating', name: 'Rating' },
        { id: 'notes', name: 'Notes', 'attributes': editableCellAttributes },
      ],
      data: [
        {% for badge in context.badges %}
          {
            icon: gridjs.html(`<div class="badge-icon" style="background:{{badge.colour}};">
        <img src={{ url_for('get_image', filename=badge.image) }}/>
      </div>`),
            name: "{{ badge.name }}",
            progress: gridjs.html(`<div
            class="progress"
            role="progressbar"
            aria-label="Basic example"
            aria-valuenow="{{badge.percentage}}"
            aria-valuemin="0"
            aria-valuemax="100"
          >
            <div class="progress-bar" style="width: {{ badge.percentage }}%">
              {{ badge.percentage | percentage_format }}
            </div>
          </div>`),
            rating: "{{ badge.rating }}",
            notes: gridjs.html(`<td contenteditable="true" class="editor">{{badge.notes}}</td>`)
          },
        {% endfor %}
      ],
      search: true,
      sort: true,
      pagination: false,
    }).render(tableDiv);

    let savedValue;


    tableDiv.addEventListener('focusin', ev => {
      if (ev.target.tagName === 'TD') {
        savedValue = ev.target.textContent;
      }
    });

    tableDiv.addEventListener('focusout', ev => {
      if (ev.target.tagName === 'TD') {
        if (savedValue !== ev.target.textContent) {
          fetch('http://127.0.0.1:5000/badge/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              id: ev.target.dataset.elementId,
              [ev.target.dataset.columnId]: ev.target.textContent
            }),
          });
        }
        savedValue = undefined;
      }
    });
</script>
{% endblock %}
